def functionJobResult(message, type) {
    currentBuild.result = type
    addDescription(message)
    if (type=='ERROR'){
        error(message)
    }
}

def addDescription(message) {
    currentBuild.description = (currentBuild?.description ?: '') + '\n' + message
}

pipeline{
   agent any 
//{
//		label 'openinsurance-devops.ca-central-1.jenkinsci.slave'
//	}
    environment {

        SVC_ACCOUNT_KEY = credentials('anderson')
    }
    stages {
 		stage('Install tools') {
 			steps {
                 dir("/home/ec2-user/workspace/") { 
                    sh 'cat /etc/*release'
                    sh 'sudo yum update -y'
                    sh 'sudo yum upgrade -y'
                    sh 'sudo yum install wget unzip -y'
                    sh 'sudo rm -f terraform_1.1.2_linux_amd64.zip'
                    sh 'wget https://releases.hashicorp.com/terraform/1.1.2/terraform_1.1.2_linux_amd64.zip'
                    sh 'sudo unzip terraform_1.1.2_linux_amd64.zip'
                    sh 'sudo mv terraform /usr/bin/'
                    sh 'terraform -v'
					sh 'ls'
                }
			}
		}
		stage('TF-Plan-Beanstalk'){
		    steps{
				dir("/home/ec2-user/workspace/tf-developer-associate/beanstalk/"){
                    echo '--- plan beanstalk'
					sh 'ls'
					sh 'pwd'
                    sh "terraform init"
                    sh "terraform plan"
				}
 		    }
		}
				stage('TF-Plan-Codebuild'){
		    steps{
				dir("/home/ec2-user/workspace/tf-developer-associate/codebuild/"){
                    echo '--- plan codebuild'
					sh 'ls'
					sh 'pwd'
                    sh "terraform init"
                    sh "terraform plan"
				}
 		    }
		}
				stage('TF-Plan'){
		    steps{
				dir("/home/ec2-user/workspace/tf-developer-associate/codepipeline/"){
                    echo '--- plan codepipeline'
					sh 'ls'
					sh 'pwd'
                    sh "terraform init"
                    sh "terraform plan"
				}
 		    }
		}
 		stage('Confirm Plan?'){
 		    steps{
                 timeout(time: 2, unit: 'HOURS') {
                     input 'Prosseguir com a Execução?'
                 }
 		    }
 		}		
		stage('TF-Create-Beanstalk'){
		    steps{
				dir("/home/ec2-user/workspace/tf-developer-associate/beanstalk/"){
                    echo '--- create beanstalk'
				    sh "terraform init"
                    sh "terraform apply --auto-approve"
				}
		    }
		}
		stage('TF-Create-Codebuild'){
		    steps{
				dir("/home/ec2-user/workspacetf-developer-associate/codebuild/"){
                    echo '--- create codebuild'
                    sh "terraform init"
                    sh "terraform apply --auto-approve"
				}
		    }
		}
		stage('TF-Create-Codepipeline'){
		    steps{
				dir("/home/ec2-user/workspace/tf-developer-associate/codepipeline/"){
                    echo '--- create codepipeline'
                    sh "terraform init"
                    sh "terraform apply --auto-approve"
				}
		    }
		}
	}
}